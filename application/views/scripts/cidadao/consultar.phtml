<!--<link rel="stylesheet" href="http://code.jquery.com/ui/1.10.4/themes/smoothness/jquery-ui.css">-->
<!--<script src="http://code.jquery.com/jquery-1.9.1.js"></script>
<script src="http://code.jquery.com/ui/1.10.4/jquery-ui.js"></script>-->
<script type="text/javascript">
    $(document).ready(function(){
        $('.btn_avaliar').click(function(){
            id = $(this).attr('idPronac');
            window.open("<?php echo $this->url(array('controller' => 'cidadao', 'action' => 'cadastrar-opiniao'), null, true); ?>?idPronac="+id,"_blank");
        });

        $('.btn_ver').click(function(){
            id = $(this).attr('idPronac');
            window.open("<?php echo $this->url(array('controller' => 'cidadao', 'action' => 'visualizar-opinioes'), null, true); ?>?idPronac="+id,"_blank");
        });

        $('.btn_imprimir').click(function(){
          //  $('#pesquisa').attr('action', '<?php echo $this->url(array('controller' => 'cidadao', 'action' => 'imprimir-listagem')); echo $this->urlComplement; ?>');
	      window.open("<?php echo $this->url(array('controller' => 'cidadao', 'action' => 'imprimir-listagem')); ?>","_blank");
              $('#pesquisa').submit();
        });

        $('.btn_xls').click(function(){
	    $('#pesquisa').attr('action', '<?php echo $this->url(array('controller' => 'cidadao', 'action' => 'xls-listagem')); echo $this->urlComplement; ?>');
	    $("#pesquisa").submit();
        });

        $('.tooltip').click(function(){
            $('#pesquisa').attr('action', '<?php echo $this->url(array('controller' => 'cidadao', 'action' => 'imprimir-listagem')); ?>');
            return false;
        });

        // Pedro - Funï¿½ï¿½o da mascara de CPF/CNPJ
	function cpf() {
            document.getElementById('CnpjCpfConsulta').maxLength = "14";
            document.getElementById('CnpjCpfConsulta').onkeyup   = function() { mascara(document.forms.pesquisa.CnpjCpfConsulta, format_cpf); };
            document.getElementById('CnpjCpfConsulta').focus();
	}
	function cnpj() {
            document.getElementById('CnpjCpfConsulta').maxLength = "18";
            document.getElementById('CnpjCpfConsulta').onkeyup   = function() { mascara(document.forms.pesquisa.CnpjCpfConsulta, format_cnpj); };
            document.getElementById('CnpjCpfConsulta').focus();
	}

	$("#CnpjCpfConsulta").keypress(function(event){
            if ($("#CnpjCpfConsulta").val().length < 14) {
		cpf();
            } else {
		cnpj();
            }
	});
	//FIM - PEDRO

	// Fernao
	$(".tabela input").keypress(function(event) {
            if (event.which == 13) {
		$('#pesquisa').attr('action', '<?php echo $this->url(array('controller' => 'cidadao', 'action' => 'consultar')); ?>');
		$("#pesquisa").submit();
            }
	});
	$(".btn_recarregar").click(function(){
	    $('#pesquisa').attr('action', '<?php echo $this->url(array('controller' => 'cidadao', 'action' => 'consultar')); ?>');
            $("#pesquisa").submit();
	});

	//Alysson - Inicio
	$(".btn_pesquisar").click(function(){
	    $('#pesquisa').attr('action', '<?php echo $this->url(array('controller' => 'cidadao', 'action' => 'consultar')); ?>');
            $("#pesquisa").submit();
	});	//Alysson - Fim

        $('#pag').change(function() {
            var url = '<?php echo $this->url(array('controller' => 'cidadao', 'action' => 'consultar')); ?><?php echo parseUrlWithParams($this->urlComplement, array('pag' => $this->paginacao['pag'] -1, 'qtde' => $this->paginacao['qtde'])); ?>';
            window.location.href = url.replace(/pag\=([0-9]{1,})/, 'pag=' + this.value);
        });
    });

</script>

<style type="text/css">
    .tooltip{
        display: inline;
        position: relative;
    }

    .tooltip:hover:after{
        background: #ddd;
        border-radius: 5px;
        border: 1px solid #ccc;
        bottom: 26px;
        color: #333;
        content: attr(title);
        left: 20%;
        padding: 10px 15px;
        position: absolute;
        z-index: 98;
        width: 320px;
        font-size: 14px;
        line-height: 1.5em;
    }

    .tooltip:hover:before{
        border: solid;
        border-color: #ddd transparent;
        border-width: 6px 6px 0 6px;
        bottom: 20px;
        content: "";
        left: 50%;
        position: absolute;
        z-index: 99;
    }

    .faleconosco{
        color: #35953F !important;
        font-size: 20px;
        text-decoration: underline !important;
	float: right;	
    }
    #NrPronacConsulta{
      width: 60px;
    }

    #NomeProjetoConsulta{
      width: 200px;
    }

    #CnpjCpfConsulta{
      width: 155px;
    }

    #ProponenteConsulta{
      width: 180px;
    }

    #idNrReuniaoConsulta{
      width: 56px;
    }
 
    #pag{
      width: 63px;
    }

    #qtde{
      width: 50px;
    }
    
    #faleconosco{

    }

    .input_simples{
      width: 110px;
    }

    table td{
      padding: 4px;
    }

</style>
<?php
// funcao generica para reescrever url com parametros e nao duplicar
function parseUrlWithParams($url, $params = array()) {
    if (empty($params)) {
        return false;
    }
    
    foreach ($params as $key => $value) {
        if ($url == '') {
            $url .= '?';
        }
        if (!preg_match('/' . $key . '/', $url)) {
            $url .= "&" . $key ."=" . $value;
        } else {
            $url = preg_replace('/(.*)' . $key . '=[a-zA-Z0-9]{1,}/', '${1}' . $key . '=' . $value , $url);
        }
    }

    return $url;
}
?>

<?php if($this->intranet){ $intranet = '&intranet'; } else { $intranet = ''; } ?>

<div id="alerta" class="sumir"></div>

<!-- ========== INICIO BREADCRUMB (LINKS TOPO) ========== -->
<div id="breadcrumb">
    <ul>
        <li class="first"><a href="<?php echo $this->url(array('controller' => 'principal', 'action' => '')); ?>" title="Ir para Inï¿½cio">Início</a></li>
        <li class="last">Lista de Projetos</li>
    </ul>
</div>
<!-- ========== FIM BREADCRUMB (LINKS TOPO) ========== -->


<!-- ========== INICIO TITULO ========== -->
<div id="titulo">
    <div class="esquerda">
    <?php if (is_object($this->reuniao)) { ?>
    Pauta da CNIC n&ordm; <?php echo $this->reuniao['NrReuniao']; ?> <?php if($this->intranet){ echo ' - Intranet'; } else { if(!$this->usuarioInterno){ echo ' - Vis&atilde;o Cidad&atilde;o'; } } ?>
    <?php } else { ?>
             &nbsp
    <?php } ?>
    <a class="faleconosco" href="http://ouvidoria.cultura.gov.br/" target="_blank">Fale conosco</a>
</div>

<!-- Alysson - Inicio Customizando a Consulta para carregar por Reuniao da CNIC -->
<fieldset>
        <form id="pesquisa" method="post">
          <!-- alinhamento filtro ( Samir ) -->
            <table style="font-size:13px;" class="tabela">
                <tr>
                    <td>
                      <label for="NrPronacConsulta">N&ordm; do PRONAC </label>
                      <input name="NrPronacConsulta" id="NrPronacConsulta" MAXLENGTH=7 class="input_simples" value="<?php echo $this->nrPronac; ?>">
                    </td>
                    <td>
                      <label for="NomeProjetoConsulta">Nome do projeto </label>
                      <input name="NomeProjetoConsulta" id="NomeProjetoConsulta" class="input_simples" value="<?php echo $this->nomeProjeto; ?>">
                    </td>
                    <td>
                      <label for="CpnjCpfConsulta">CPF/CNPJ </label>
                      <input type="text" name="CnpjCpfConsulta" id="CnpjCpfConsulta" class="input_simples" value="<?php echo $this->cnpjCpf; ?>">
                    </td>
                    <td>
                      <label for="ProponenteConsulta">Proponente </label>
        			        <input type="text" name="ProponenteConsulta" id="ProponenteConsulta" class="input_simples" value="<?php echo $this->proponente; ?>">
                    </td>
                    <td>
                      <label for="idNrReuniaoConsulta">N&ordm; da Reuni&atilde;o </label>
		      <select class="input_simples" name="idNrReuniaoConsulta" id="idNrReuniaoConsulta">
			<option value="" selected></option>
			<?php foreach($this->listaReunioes as $u){
			$selected = ($this->idNrReuniaoConsulta == $u->idNrReuniao) ? "selected" : ""; ?>
			<option value="<?php echo $u->idNrReuniao;?>" <?php echo $selected; ?>><?php echo $u->NrReuniao;?></option>
			<?php } ?>
		      </select>
                    </td>
                    <td>
                        <input type="button" name="procurar" class="btn_pesquisar" value=" " /><br>
                    </td>
                </tr>
            </table>
    </fieldset>
<!-- Alysson - Fim Customizando a Consulta para carregar por Reuniao da CNIC -->
</div>
<div id="conteudo" align="center">

    <?php if(count($this->dados)>0){ ?>
    <!-- ============ PAGINACAO ============ -->
    <table class="tabela" style="width: 97%;" border="0" cellpadding="0" cellspacing="0">
      <tbody>
             <tr>
                 <td align="center">
                     <?php if($this->paginacao['pag']>1) { ?>
                     <input class="btn_inicio" id="btn_inicio" type="button" class="btn_inicio"
                           onclick="location.href='<?php echo $this->url(array('controller' => 'cidadao', 'action' => 'consultar')); ?><?php echo parseUrlWithParams($this->urlComplement, array('pag' => 1, 'qtde' => $this->paginacao['qtde'])); ?>'">
                     <?php } ?>
                     <input id="btn_p_anterior" type="button"
                     <?php if($this->paginacao['pag']<=1) { ?> class="btn_p_anterior-off"
                     <?php }else { ?>
                           class="btn_p_anterior" onclick="location.href='<?php echo $this->url(array('controller' => 'cidadao', 'action' => 'consultar')); ?><?php echo parseUrlWithParams($this->urlComplement, array('pag' => $this->paginacao['pag'] -1, 'qtde' => $this->paginacao['qtde'])); ?>'"
                    <?php } ?>>
                     <input id="btn_p_proximo" type="button"
                            <?php if($this->paginacao['pag']+1 > $this->paginacao['totalPag']) { ?>
                           class="btn_p_proximo-off"
                     <?php }else { ?>
                           class="btn_p_proximo" onclick="location.href='<?php echo $this->url(array('controller' => 'cidadao', 'action' => 'consultar')); ?><?php echo parseUrlWithParams($this->urlComplement, array('pag' => $this->paginacao['pag'] +1, 'qtde' => $this->paginacao['qtde'])); ?>'"
                    <?php } ?>>
                     <?php if($this->paginacao['pag'] < $this->paginacao['totalPag']) { ?>
                     <input class="btn_ultimo" id="btn_ultimo" type="button"
                           onclick="location.href='<?php echo $this->url(array('controller' => 'cidadao', 'action' => 'consultar')); ?><?php echo parseUrlWithParams($this->urlComplement, array('pag' => $this->paginacao['totalPag'], 'qtde' => $this->paginacao['qtde'])); ?>'">
                     <?php } ?>
                    P&aacute;g.:<select name="pag" id="pag" class="input_simples">
                         <?php $i=1; ?>
                         <?php for($i=1; $i<=$this->paginacao['totalPag']; $i++):?>
                           <option value='<?php echo $i; ?>' <?php if ($i == $this->paginacao['pag']) { echo "selected"; } ?>><?php echo $i; ?></option>
                         <?php endfor; ?>
                    </select>
                    &nbsp;Registros por p&aacute;gina:<input type="text" size="1" name="qtde" id="qtde" class="input_simples" value="<?php echo $this->intTamPag;?>"><input type="button" class="btn_recarregar" value="">
                    <input type="hidden" name="campo" value="<?php echo $this->paginacao['campo'];?>">
                    <input type="hidden" name="ordem" value="<?php echo $this->paginacao['ordem'];?>">
<!--                    <input type="hidden" name="tipoFiltro" value="<?php echo $this->filtro;?>">-->
                    <input type="hidden" name="pronac" value="<?php echo $this->pronacProjeto;?>">
                    <input type="button" class="btn_imprimir" title="Imprimir" />
                    <input type="button" class="btn_xls" title="Gerar Excel" />
                 </form>
                </td>
            </tr>
        </tbody>
    </table>
    <center>
        <?php
            echo $this->paginacao['inicio']." a ";
            echo ($this->paginacao['pag']-1)*$this->paginacao['Itenspag'] + $this->paginacao['tamanho'];
            echo " de ". $this->paginacao['total']. " Projetos listados";
        ?>
    </center>
    <!-- ========== FIM PAGINACAO ========== -->
    <?php } ?>

    <?php if(count($this->dados)>0){ ?>
    <table class="tabela tablesorter">
        <thead>
            <tr class="titulo_tabela">
              <th><a href="<?php echo $this->url(array('controller' => 'cidadao', 'action' => 'consultar')); ?><?php echo parseUrlWithParams($this->urlComplement, array('campo' => 1, 'ordem' => "$this->novaOrdem")); ?>">PRONAC</a></th>
              <th><a href="<?php echo $this->url(array('controller' => 'cidadao', 'action' => 'consultar')); ?><?php echo parseUrlWithParams($this->urlComplement, array('campo' => 3, 'ordem' => "$this->novaOrdem")); ?>">Nome do Projeto</a> <br /><span class="red" style="text-transform: none;">Passe o mouse sobre o nome do projeto para ver a s&iacute;ntese</span></th>
              <th><a href="<?php echo $this->url(array('controller' => 'cidadao', 'action' => 'consultar')); ?><?php echo parseUrlWithParams($this->urlComplement, array('campo' => 4, 'ordem' => "$this->novaOrdem")); ?>">Proponente</a></th>
              <th><a href="<?php echo $this->url(array('controller' => 'cidadao', 'action' => 'consultar')); ?><?php echo parseUrlWithParams($this->urlComplement, array('campo' => 5, 'ordem' => "$this->novaOrdem")); ?>">UF</a></th>
              <th><a href="<?php echo $this->url(array('controller' => 'cidadao', 'action' => 'consultar')); ?><?php echo parseUrlWithParams($this->urlComplement, array('campo' => 6, 'ordem' => "$this->novaOrdem")); ?>">Munic&iacute;pio</a></th>
              <th><a href="<?php echo $this->url(array('controller' => 'cidadao', 'action' => 'consultar')); ?><?php echo parseUrlWithParams($this->urlComplement, array('campo' => 7, 'ordem' => "$this->novaOrdem")); ?>">Enquadramento</a></th>
              <th><a href="<?php echo $this->url(array('controller' => 'cidadao', 'action' => 'consultar')); ?><?php echo parseUrlWithParams($this->urlComplement, array('campo' => 8, 'ordem' => "$this->novaOrdem")); ?>">&Aacute;rea</a></th>                                     
              <th><a href="<?php echo $this->url(array('controller' => 'cidadao', 'action' => 'consultar')); ?><?php echo parseUrlWithParams($this->urlComplement, array('campo' => 9, 'ordem' => "$this->novaOrdem")); ?>">Segmento</a></th>
              <th><a href="<?php echo $this->url(array('controller' => 'cidadao', 'action' => 'consultar')); ?><?php echo parseUrlWithParams($this->urlComplement, array('campo' => 15, 'ordem' => "$this->novaOrdem")); ?>">Dt. In&iacute;cio Execu&ccedil;&atilde;o</a></th>
              <th><a href="<?php echo $this->url(array('controller' => 'cidadao', 'action' => 'consultar')); ?><?php echo parseUrlWithParams($this->urlComplement, array('campo' => 16, 'ordem' => "$this->novaOrdem")); ?>">Dt. T&eacute;rmino Execu&ccedil;&atilde;o</a></th>                                                                                                               
	      <th><a href="<?php echo $this->url(array('controller' => 'cidadao', 'action' => 'consultar')); ?><?php echo parseUrlWithParams($this->urlComplement, array('campo' => 10, 'ordem' => "$this->novaOrdem")); ?>">Avalia&ccedil;&atilde;o</a></th>                                                                                                               
              <th><a href="<?php echo $this->url(array('controller' => 'cidadao', 'action' => 'consultar')); ?><?php echo parseUrlWithParams($this->urlComplement, array('campo' => 11, 'ordem' => "$this->novaOrdem")); ?>">Vl.Solicitado</a></th>                                                                                                               
              <th><a href="<?php echo $this->url(array('controller' => 'cidadao', 'action' => 'consultar')); ?><?php echo parseUrlWithParams($this->urlComplement, array('campo' => 12, 'ordem' => "$this->novaOrdem")); ?>">Vl.Aprovado</a></th>                                                                                                               
              <th><a href="<?php echo $this->url(array('controller' => 'cidadao', 'action' => 'consultar')); ?><?php echo parseUrlWithParams($this->urlComplement, array('campo' => 13, 'ordem' => "$this->novaOrdem")); ?>">Vl.Captado</a></th>                                                                                                               

                <?php /*if(!$this->intranet){ ?>
                <th><?php echo ($this->usuarioInterno) ? 'Opini&otilde;es' : 'Cidad&atilde;o'; ?></th>
                <?php }*/ ?>
            </tr>
        </thead>
        <tbody>
            <?php 
            $TotalSolicitado = 0;
            $TotalAprovado = 0; 
            $TotalCaptado = 0; 
            ?>
            <?php foreach($this->dados as $d){ ?>
            <tr>
                <td align="center" class="w100">
                    <a href="<?php echo $this->url(array('controller' => 'verprojetos', 'action' => 'index'));?>?idPronac=<?php echo Seguranca::encrypt($d->idPronac); ?>" target="_blank">
                        <?php echo $d->Pronac; ?>
                    </a>
                </td>
                <td>
                    <a href="#" title="<?php echo $d->ResumoProjeto; ?>" class="tooltip" style="text-decoration: none;">
                        <span title=" "><?php echo $d->NomeProjeto; ?></span>
                    </a>
                </td>
                <td><?php echo $d->Proponente; ?></td>
                <td><?php echo $d->UF; ?></td>
                <td><?php echo $d->Cidade; ?></td>
                <td><?php echo $d->descEnquadramento; ?></td>
                <td><?php echo $d->dsArea; ?></td>
                <td><?php echo $d->dsSegmento; ?></td>

<!--Se passar da data, o valor fica em vermelho -->
<?php
                     if(!empty($d->DtFimExecucao)){
                         $classRed = '';
                         $hoje = new DateTime();
                         $fimExecucao = new DateTime($d->DtFimExecucao);

                         if($hoje > $fimExecucao){
                             $classRed = 'style="color:red;"';
                         }
                     }
?>
<!--FIM-->

		<td align="center" class="bold" <?php echo $classRed; ?>><?php echo !empty($d->DtInicioExecucao) ? Data::tratarDataZend($d->DtInicioExecucao, 'Brasileira') : '<em>Dados n&atilde;o informados!</em>'; ?></td>
 	        <td align="center" class="bold" <?php echo $classRed; ?>><?php echo !empty($d->DtFimExecucao) ? Data::tratarDataZend($d->DtFimExecucao, 'Brasileira') : '<em>Dados n&atilde;o informados!</em>'; ?></td>
            
<td>
                    <a href="<?php echo $this->url(array('controller' => 'cidadao', 'action' => 'parecer-consolidado'));?>?idPronac=<?php echo Seguranca::encrypt($d->idPronac); ?>" target="_blank"><?php echo $d->descAvaliacao; ?></a>
                </td>
                <td align="right"><?php echo (!empty($d->vlSolicitado)) ? @number_format($d->vlSolicitado, 2, ",", ".") : ''; ?></td>
                <td align="right"><?php echo (!empty($d->vlAprovado)) ? @number_format($d->vlAprovado, 2, ",", ".") : ''; ?></td>
                <td align="right"><?php echo (!empty($d->vlCaptado)) ? @number_format($d->vlCaptado, 2, ",", ".") : ''; ?></td>

            </tr>
            <?php 
            $TotalSolicitado = $TotalSolicitado + $d->vlSolicitado; 
            $TotalAprovado = $TotalAprovado + $d->vlAprovado;
            $TotalCaptado = $TotalCaptado + $d->vlCaptado;
            } ?>
            <tr class="direita bold destacar" style="font-size: 14px;">
                <td colspan="11" style="padding: 15px 5px;">TOTAL</td>
                <td nowrap><?php echo @number_format($TotalSolicitado, 2, ",", "."); ?></td>
                <td nowrap><?php echo @number_format($TotalAprovado, 2, ",", "."); ?></td>
                <td nowrap><?php echo @number_format($TotalCaptado, 2, ",", "."); ?></td>
            </tr>
        </tbody>
    </table>

    <br clear="all" />
    <center>
        <?php echo count($this->dados). " Projetos listados"; ?>
	</br>
		<input type="button" class="btn_imprimir">
        <input type="button" class="btn_xls" />
    </center>

    <?php } else { ?>
    <table class="tabela">
        <tr>
            <td align="center">Nenhum registro encontrado.</td>
        </tr>
    </table>
    <?php } ?>
    <br clear="all" />
</div>


<!-- ========== INICIO RODAPE DO CONTEUDO ========== -->
<div id="rodapeConteudo"><span></span></div>
<!-- ========== FIM RODAPE DO CONTEUDO ========== -->
<br clear="all" />
