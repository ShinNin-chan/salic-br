<script type="text/javascript" src="<?php echo $this->baseUrl(); ?>/public/js/ckeditor/ckeditor.js"></script>
<script type="text/javascript" src="<?php echo $this->baseUrl(); ?>/public/js/ckeditor/_samples/sample.js"></script>
<link type="text/css" rel="stylesheet" href="<?php echo $this->baseUrl(); ?>/public/js/ckeditor/_samples/sample.css" />

<!-- ========== INÍCIO BREADCRUMB (LINKS TOPO) ========== -->
<div id="breadcrumb">
    <ul>
        <li class="first"><a href="<?php echo $this->url(array('controller' => 'principal', 'action' => ''), '', true); ?>" title="Ir para P&aacute;gina Inicial">In&iacute;cio</a></li>
        <li class="second">An&aacute;lise T&eacute;cnica Inicial</li>
        <li class="second"><a href="<?php echo $this->url(array('controller' => 'analisarprojetoparecer', 'action' => 'index'), '', true); ?>" title="Ir para P&aacute;gina Inicial">Projetos/Produtos para An&aacute;lise</a></li>
        <li class="last">An&aacute;lise do Produtos</li>
    </ul>
</div>
<!-- ========== FIM BREADCRUMB (LINKS TOPO) ========== -->



<!-- ========== INÍCIO T�TULO ========== -->
<div id="titulo">
    <div>An&aacute;lise do Produto <span class="voltar"><a href="javascript:voltar();" title="P&aacute;gina Anterior">Voltar</a></span></div>
</div>
<!-- ========== FIM T�TULO ========== -->

<div id="dialog-valor" class="sumir" title="Valor Inv&aacute;lido">
    <div class="msgERROR">
        <div>Valor de remanejamento maior que o permitido! M&aacute;ximo : <span id="valorpossivelApresentacao"></span></div>
    </div>
</div>

<!-- ========== INÍCIO CONTE�DO ========== -->
<div id="conteudo">
    <table class="tabela" >
        <tr>
            <th colspan="6">
              Parecer T&eacute;cnico do Projeto      
            </th>
        </tr>
	<tr>
	  <td width="10%">PRONAC: </td><td><?php echo $this->projeto->PRONAC; ?></td><td colspan="3"><strong><?php echo $this->projeto->NomeProjeto; ?></strong></td>
	</tr>
	<tr>
	  <td width="10%">&Aacute;rea:</td><td><?php echo $this->projeto->dsArea; ?></td><td>Segmento:</td><td><?php echo $this->projeto->dsSegmento; ?></td>
	</tr>
	<tr>
	  <td>Produto:</td>
	  <td colspan="6">
	    <?php
                if ($this->projeto->stPrincipal) {
                    echo 'Principal';
                } else {
                    echo 'Secundario';
                }
                ?>: <?php echo $this->projeto->dsProduto; ?>	
	  </td>
	</tr>
    </table>
    <!-- FIM ANALISE DE CONTE&UACUTE;DO  -->
    <!-- Formulario -->
    <div id="divAnaliseConteudo">
        <form name="formAnaliseConteudo" id="formAnaliseConteudo" action="<?php echo $this->url(array('controller' => 'analisarprojetoparecer', 'action' => 'analisedeconteudo')); ?>" method="post">
            <input type="hidden" id="stAcao" name="stAcao" value="0"/>
            <input type="hidden" name="idPRONAC" value="<?php echo $this->projeto->IdPRONAC; ?>"/>
            <input type="hidden" name="idProduto" value="<?php echo $this->projeto->idProduto; ?>"/>
            <input type="hidden" id="stPrincipal" name="stPrincipal" value="<?php echo $this->projeto->stPrincipal; ?>"/>
            <input type="hidden" id="idD" name="idD" value="<?php echo $this->idD; ?>"/>

            <table class="tabela" style="width: 95%;">
                <tr>
                    <td colspan="5">
                        <b>Parecer t&eacute;cnico*</b>
                        <p>
                        <center>
                            <textarea class="textarea_simples" id="ParecerDeConteudo" name="ParecerDeConteudo" rows="10" style="width: 98%;"></textarea>
                        </center>
                    </td>
                </tr>
                <tr>
                    <td colspan="5">
                        <b>Posicionamento do parecerista *</b>
                        <p style="margin-top: 10px;">
                            <input type="radio" style="margin-right: 5px;" value="1" class="ParecerFavoravel" name="ParecerFavoravel" checked="checked" />Parecer favor&aacute;vel &nbsp;&nbsp;
                            <input type="radio" style="margin-right: 5px;" value="0" class="ParecerFavoravel" name="ParecerFavoravel" />Parecer desfavor&aacute;vel
                        </p>
                    </td>
                </tr>
		
                <tr id="btSalvar">
                    <td colspan="6" align="center">
                        <input type="button" id="btSalvarAnaliseDeConteudo" value=" " class="btn_salvar"/>
                    </td>
                </tr>
            </table>
        </form>
    </div>

    <div id="confirmacao" style="display: none;"></div>
    <!-- FIM MODAL -->
</div>
<!-- ========== FIM CONTE&UACUTE;DO ========== -->

<div id="confirma" class="sumir"></div>
<div id="camposObrigatorios" class="sumir"></div>

<!-- ========== INÍCIO RODAP� DO CONTE&UACUTE;DO ========== -->
<div id="rodapeConteudo"><span></span></div>
<!-- ========== FIM RODAP� DO CONTE&UACUTE;DO ========== -->
<input type="hidden" name="grupoAtivo" id="grupoAtivo" value="<?php echo $this->grupoAtivo; ?>" />
<br clear="all" />

<script type="text/javascript">

    function carregarSegmento(){
        $('#segmentoCultural').html('<option value=""> - Carregando - </option>');
        $.ajax({
            type: 'POST',
            url: '<?php echo $this->url(array('controller' => 'segmento', 'action' => 'combo')); ?>',
            data: {
                id: $('#areaCultural').val()
            },
            success: function(dados) {
                $('#segmentoCultural').find('option').remove();
                $('#segmentoCultural').append(dados);
            }
        });
    }

    function carregarEnquadramento(){
        var listaCodSegmento = [ '11','12','13','14','15','17','23','26', '28', '2A','2B','2E','2F','2G','2H','2I','2J','2K','2L','32','33','36','4B','4D','5A','5D','5E','5F','5G','5H','5I','5J','5K','5L','5M','5N','5O','5P','62','65','68','6C','6D','6E','6G','6H' ];
        if(in_array($('#segmentoCultural').val(), listaCodSegmento)){
            $('#enquadramentoProjeto').val('2');
            $('#enquadramentoText').html('Artigo 18');
        } else {
            $('#enquadramentoProjeto').val('1');
            $('#enquadramentoText').html('Artigo 26');
        }
    }
    function carregarTextAreaCKEditor(){
        CKEDITOR.replace( 'ParecerDeConteudo', { toolbar: [] } );
        <?php if(($this->stPrincipal == 1) && ($this->produtosSecundariosEmAnalise == 0)){ ?>
        CKEDITOR.replace( 'dsConsolidacao', { toolbar: [] } );
        <?php } ?>
    }

    $(document).ready(function(){
        
        carregarAnaliseDeConteudo();
        $('#btSalvarAnaliseDeConteudo').click(function(){
            var parecer = CKEDITOR.instances['ParecerDeConteudo'].getData().toString().replace(/(<.*?>)|(&nbsp;)|(\s+)/g,'');
//            var parecer = $('#ParecerDeConteudo').val();
            if( parecer.length  < 11){
                alertar('O parecer t�cnico deve ter no m�nimo 11 caracter!');
            } else {
                $('#formAnaliseConteudo').submit();
            }
            return false;
        });

        window.setTimeout('carregarTextAreaCKEditor()', 1000);
        
        $('#areaCultural').change(function() {
            carregarSegmento();
        });

        $('#segmentoCultural').change(function() {
            carregarEnquadramento();
        });

        $('#btSalvarConsolidacao').click(function() {
            var i = 0;
            $('.obrigatorio').each(function(){
                if($.trim($(this).val()) == ''){
                    i++;
                }
            });

            var boolValid = false;
            $('.obrigatorioRadio').each(function() {
                if ($(this).is(':checked') ) {
                    boolValid = true;
                }
            });

            var texto = CKEDITOR.instances['dsConsolidacao'].getData().toString().replace(/(<.*?>)|(&nbsp;)|(\s+)/g,'');
//            var texto = $('#dsConsolidacao').val();
            if (texto == '' || texto == 'Digiteseutextoaqui...'){
                i++;
            }

            if(i > 0 || !boolValid) {
                $("#camposObrigatorios").dialog("destroy");
                $("#camposObrigatorios").html("Favor preencher os dados obrig&aacute;torios!");
                $("#camposObrigatorios").dialog({
                    resizable: false,
                    title: 'Alerta!',
                    width:320,
                    height:160,
                    modal: true,
                    buttons : {
                        'OK' : function(){
                            $(this).dialog('close');
                        }
                    }
                });
                $('.ui-dialog-titlebar-close').remove();

            } else {
                $('#formConsolidacao').submit();
            }
        });

        $("#valorpossivelApresentacao").html('<?php echo $this->formatarReal($this->valorpossivel);?>');
        var grupoAtivo = $("#grupoAtivo").val();
        if(grupoAtivo == "93"){
            desabilitaFormConteudo(true);
            $("#divAnaliseCusto a").click(function() { return false; });
        }

        var cont = 0;
        $('.class_relatorio').each(function(){
            var contAux = cont;
            $('#abrir_fechar'+contAux).click(function(){
                $('#div_relatorio'+contAux).toggle('slow');
            });
            cont++;
        });


        $('.linkrelatorio').click(function(){
            var este = this;
            var cont = $(este).attr('cont');
            $('#div_relatorio'+cont).html('<table class="tabelaRelatorio" cellspacing="1" style="margin: 0;margin-left: 52px; width: 90%;  padding: 0px;"><tr><td align="center"><img src="../public/img/ajax.gif"/>&nbsp;Carregando...</td><tr></table>');
            $('#div_relatorio'+cont).css('display','');
            $.post($(este).attr('link'),{nrRelatorio: cont,idPRONAC:<?php echo $this->projeto->IdPRONAC; ?>},function(data){
                $('#div_relatorio'+$(este).attr('cont')).html(data);
            });
        });
        $(".icn_menos").click(function(){
            var tipo = $(this).attr('tipo');
            var aberto = $(this).attr('aberto');
            if(aberto == 'true'){
                adisplay = 'none';
                $(this).attr('aberto','false');
                $(this).removeClass('icn_menos').addClass('icn_mais');
            }
            else{
                adisplay = '';
                $(this).attr('aberto','true');
                $(this).removeClass('icn_mais').addClass('icn_menos');
            }
            if(tipo == 'fonte'){
                fonte = $(this).attr('fonte');
                $(".master[fonte='"+fonte+"']").css('display', adisplay);
                $(".clickproduto").removeClass('icn_mais').addClass('icn_menos');
            }
            if(tipo == 'produto'){
                fonte = $(this).attr('fonte');
                produto = $(this).attr('produto');
                $(".produto[produto='"+produto+"'][fonte='"+fonte+"']").css('display', adisplay);
            }
            if(tipo == 'etapa'){
                fonte = $(this).attr('fonte');
                produto = $(this).attr('produto');
                etapa = $(this).attr('etapa');
                $(".etapa[produto='"+produto+"'][etapa='"+etapa+"'][fonte='"+fonte+"']").css('display', adisplay);
            }
            if(tipo == 'cidade'){
                fonte = $(this).attr('fonte');
                produto = $(this).attr('produto');
                etapa = $(this).attr('etapa');
                cidade = $(this).attr('cidade');
                $(".cidade[produto='"+produto+"'][etapa='"+etapa+"'][cidade='"+cidade+"'][fonte='"+fonte+"']").css('display', adisplay);
            }
        });
        $(".item").mouseover(function(){
            $(this).addClass('fundo_linha3');
        });
        $(".item").mouseout(function(){
            $(this).removeClass('fundo_linha3');
        });
        $(".item").click(function(){
            if($(this).hasClass('fundo_linha4')){
                $(this).removeClass('fundo_linha4');
            }
            else{
                $(this).addClass('fundo_linha4');
            }
        });

        APPescolherLei_8313();

        carregarEnquadramento();
    }); //fecha document.ready

    function abrirfechar(elemento){
        $('#'+elemento).toggle();
    }

    function desabilitaFormConteudo(habilitar){
        $('#formAnaliseConteudo').find('input, select, textarea').each(function(key, object){
            if(habilitar){
                $(object).attr('disabled','true');
            }else{
                $(object).removeAttr('disabled');
            }
        });
    }
    function janelaAnaliseConteudoConfirm(stPrincipal,mensagem1,mensagem2){
        var nomeJanelaAlerta =   janelaObj({
            parametros : {
                width:      400,
                autoOpen:   false,
                resizable:  false,
                modal:      true,
                buttons: {
                    'N\u00e3o': function() {
                        $(this).dialog('close');
                    },
                    Sim: function() {
                        $('#formAnaliseConteudo').submit();
                        $(this).dialog('close');
                    }
                }
            },
            removerBtFechar:true,
            title : 'Alerta'
        });
        if(stPrincipal == 1){
            nomeJanelaAlerta.divConteudo.html(mensagem1);
        }else{
            nomeJanelaAlerta.divConteudo.html(mensagem2);
        }
        nomeJanelaAlerta.abrirJanela();

        return nomeJanelaAlerta;
    }

    function AlterarItem(idPlanilhaProjeto,idPronac,idProduto,stPrincipal)
    {
        //$('html').css('overflow', 'hidden');
        var este = $('#alteraritemsolicitado');
        este.html('<br><br><br><br><br><br><br><center>Aguarde, carregando dados...<br><img src="<?php echo $this->baseUrl(); ?>/public/img/ajax.gif" /></center><br>');
        este.dialog(
        {
            title:"Alterar Item",
            resizable: false,
            width:800,
            height:600,
            modal: false,
            autoOpen:true,
            closeOnEscape:true
        });

        $.post(este.attr('link'),{idPlanilhaProjeto:idPlanilhaProjeto,idPronac:idPronac,idProduto:idProduto,stPrincipal:stPrincipal}
        ,function(data)
        {

            este.html(data);
            este.dialog(
            {
                title:"Alterar Item",
                resizable: false,
                width:800,
                height:600,
                modal: false,
                autoOpen:true,
                closeOnEscape:true,
                buttons:
                    {
                    'Cancelar': function()
                    {
                        $(this).dialog('close');
                        //$('html').css('overflow', 'auto');
                    },
                    'Salvar': function()
                    {

                        var texto = $('#justificativa'+$('#idPlanilhaProjeto').val()).val();
                        texto = texto.replace(/^\s+|\s+$/g,""); //retirando espa�os
                        if (texto.length <= 0 || texto=="")
                        {
                            alertar('Dados obrigat�rios n�o informados.');
                            return false;
                        }
                        else
                        {
                            var vlSugerido = $('#calcular_total'+$('#idPlanilhaProjeto').val()).html().replace(/\R\$\s+/g, '');
                            $('#totalcalculos'+$('#idPlanilhaProjeto').val()).val(vlSugerido);

                            var dados = $('#formSalvarItem').serialize();
                            $(this).append('<br><center>Aguarde, salvando informa��es...<br><img src="<?php echo $this->baseUrl(); ?>/public/img/ajax.gif" /></center><br>');
                            $.post($('#formSalvarItem').attr('action'),dados
                            ,function(data)
                            {
                                var resposta = data;
                                $('#item'+$('#idPlanilhaProjeto').val()+' .JustParecerista').html($("#justificativa"+$('#idPlanilhaProjeto').val()).val());
                                $('#item'+$('#idPlanilhaProjeto').val()+' .ValorSugerido').html($("#calcular_total"+$('#idPlanilhaProjeto').val()).html());
                                somarValores();

                                //atualiza novo valor possivel de remanejamento
                                var vlSolicitado = '<?php echo $this->vlSolicitado;?>';
                                var vlTotalSugerido = recuperaTotalSugerido();
                                var valorpossivel = vlSolicitado - vlTotalSugerido;

                                $("#valorpossivel").val(valorpossivel);

                                //atualiza campo de apresentacao do novo valor possivel de remanejamento
                                var valorpossivelApresentacao = formatarParaReal(valorpossivel);
                                $("#valorpossivelApresentacao").html(valorpossivelApresentacao);

                                este.dialog('close');
                                janelaAlerta('Informa��es salvas com sucesso');
                            });

                        }
                    }
                }
            });
        });


    }

    function recuperaTotalSugerido()
    {
        // pega o valor total do relator
        var valor = $('.valorTotalSugerido').html();
        valor = valor.replace('R$ ', '');

        // retira os pontos e as virgulas, deixando somente numeros
        valor = valor.replace(/\D/g, "");
        valor = valor.replace(/(\d{0})(\d)/, "$1$2");

        // adiciona o ponto na casa decimal
        valor = valor.replace(/(\d)(\d{2})$/, "$1.$2");

        // converte para float
        valor = parseFloat(valor);

        return valor;
    }

    // formata para real
    function formatarParaReal(valor)
    {
        valor = (parseFloat(valor)).toFixed(2);
        valor = valor.replace(/\D/g, "");
        valor = valor.replace(/(\d)(\d{2})$/, "$1,$2");
        valor = valor.replace(/(\d+)(\d{3},\d{2})$/g, "$1.$2");

        var q = (valor.length - 3) / 3; // quantidade caracteres
        var c = 0; // contador
        while (q > c)
        {
            c++;
            valor = valor.replace(/(\d+)(\d{3}.*)/, "$1.$2");
        }
        valor = valor.replace(/^(0+)(\d)/g, "$2");
        valor = 'R$ ' + valor;

        return valor;
    }

    function areadetrabalho()
    {
        $('#abrir_fechar4').click(function()
        {
            $('#enquadramento').toggle('slow');
            $('#parecer').toggle('slow');
            $('#divAnaliseConteudo').hide('slow');
            $('#div_teste2').hide('slow');
        });

        $('#abaAnaliseConteudo').click(function()
        {
            $('#divAnaliseConteudo').toggle('slow');
        });

        $('#abaAnaliseCusto').click(function()
        {
            $('#divAnaliseCusto').toggle('slow');
        });
    }

    window.onload = function()
    {
        areadetrabalho();
    };

    function AbrirFecharPlanilha(elemento)
    {
        $('.' + elemento).toggle();
        if ($('#' + elemento).hasClass('icn_mais'))
        {
            $('#' + elemento).addClass('icn_menos');
            $('#' + elemento).removeClass('icn_mais');
        }
        else
        {
            $('#' + elemento).addClass('icn_mais');
            $('#' + elemento).removeClass('icn_menos');
        }
    }

    function carregarAnaliseDeConteudo()
    {
        recuperaFormulario($('#formAnaliseConteudo').attr('action'),{stAcao: 1, idPRONAC: <?php echo $this->projeto->IdPRONAC; ?>, idProduto: <?php echo $this->projeto->idProduto; ?>, stPrincipal:<?php echo $this->projeto->stPrincipal; ?>});
        return true;
    }

    function recuperaFormulario(url,params){
        if(params.length < 1)
        {
            params = {};
        }
        var btSalvar = false;
        $.post(url,params,function(data){
            if(data){
                $('#formAnaliseConteudo').find('input, select, textarea').each(function(key, object){
                    if($(object).attr('type') == 'radio'){
                        if($(object).val() == data[$(object).attr('name')]){
                            btSalvar = true;
                            $(object).attr('checked','true');
                        }
                    }else{
                        if($(object).attr('type') == 'checkbox'){
                            if(data[$(object).attr('name')] == 1){
                                btSalvar = true;
                                $(object).attr('checked','true');
                            }
                        }else{
                            btSalvar = true;
//                            if($(object).attr('type') == 'textarea'){
//                                console.debug(object);
//                            } else {
                                $(object).val(data[$(object).attr('name')]);
//                            }
                        }
                    }
                });
                $('#stAcao').val(2);
                // desabilitaFormConteudo(false);
            }else{
                $('#stAcao').val(3);
            }
        },'json');
    }

    function AbrirFecharPlanilha(elemento){
        $('.' + elemento).toggle();

        if ($('#' + elemento).hasClass('icn_mais'))
        {
            $('#' + elemento).addClass('icn_menos');
            $('#' + elemento).removeClass('icn_mais');
        }
        else
        {
            $('#' + elemento).addClass('icn_mais');
            $('#' + elemento).removeClass('icn_menos');
        }
        return false;
    }
    function janelaAlerta(mensagem,funcaoAdcional)
    {
        if(funcaoAdcional==undefined)
        {
            funcaoAdcional = function(){}
        }
        var nomeJanelaAlerta =   janelaObj({
            parametros : {
                width:      400,
                autoOpen:   false,
                resizable:  false,
                modal:      true,
                buttons: {
                    OK: function() {
                        funcaoAdcional();
                        $(this).dialog('close');
                    }
                }
            },
            removerBtFechar:true,
            title : 'Alerta'
        });
        nomeJanelaAlerta.divConteudo.html(mensagem);
        nomeJanelaAlerta.abrirJanela();

        return nomeJanelaAlerta;
    }
    function janelaObj(dados){
        var divConteudo = $('<div></div>')
        .attr('title',dados.title)
        .appendTo('body');
        var novaJanela =
            {
            divConteudo : divConteudo,
            removerBtFechar: true,
            parametros : {autoOpen: false},
            iniciarJanela : function(dados){
                this.refineParametrosObj(dados);

                this.divConteudo.dialog(this.parametros);
            },
            abrirJanela:function(){
                this.divConteudo.dialog('open');
                if(this.removerBtFechar)
                    $('.ui-dialog-titlebar-close').remove();
            },
            fecharJanela:function(){
                this.divConteudo.dialog('close');
                this.divConteudo.remove();
            },
            refineParametrosObj : function(data){
                if(data!= undefined)
                    for(var j in data){
                        this[j]=data[j];
                    }
            }
        }
        novaJanela.iniciarJanela(dados);
        return novaJanela;
    }
</script>
<script type="text/javascript">APPescolherArt_18(); APPescolherArt_26(); APPescolherLei_8313(); APPescolherArtigo3();</script>
