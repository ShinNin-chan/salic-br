<script>
$(document).ready(function(){

        <?php if(isset($this->movimentacaoAtual) && $this->movimentacaoAtual != '95'): ?>
             //DESABILITA ALTERACOES NOS DADOS DO FORMULARIO (INCLUIR/ALTERAR/EXCLUIR)
             JSBloquearAlteracaoFormulario();
        <?php endif; ?>

	$(".produto").click(function(){
		var etapa = $(this).parent().parent().parent().parent().find('.etapas');
		if(etapa.css('display')== 'none'){
            $(this).addClass('btn_remover');
            $(this).removeClass('btn_adicionar');
            etapa.css('display','');
		}
		else{
            $(this).addClass('btn_adicionar');
            $(this).removeClass('btn_remover');
            etapa.css('display','none');
		}
	});
});

function abrirDinamico(elemento, obj) {
    if($(elemento).css('display') == 'none') {
        $(elemento).fadeIn('fast', function() {
            $('img', $(obj)).attr('src','<?php echo $this->baseUrl(); ?>/public/img/navigation-baixo.PNG');
        });
    } else {
        $(elemento).fadeOut('fast', function() {
            $('img', $(obj)).attr('src','<?php echo $this->baseUrl(); ?>/public/img/navigation-right.png');
        });
    }
}

function abrirFrmCadastroItem(url){
    $('html').css('overflow', 'hidden');
    $("#frmCadastroItem").html("");
    // modal com os ddos do dirigente
    $("#frmCadastroItem").dialog("destroy");
    $("#frmCadastroItem").dialog
    ({
        width:$(window).width() - 90,
        height:$(window).height() - 40,
        draggable:false,
        EscClose:false,
        modal:true,
        close: function(){
            window.location.reload();
        }
    });
    jqAjaxLink(url, null, "frmCadastroItem");
}
</script>
<div id="frmCadastroItem" style="text-align: center; display: none;"></div>
<?php echo $this->partial("manterpropostaincentivofiscal/inc/menu.inc.php", $this); ?>
<?php
        $controller = "manterorcamento";
        $links = array(
            array('Lista de Propostas' => array('controller' => 'manterpropostaincentivofiscal','action' => 'listar-propostas')),
            array('Or&ccedil;amento' => array())
        );
montaGuiaLinks($controller, $links);
?>

<style>

    table {
        width:100%;
        border: 1px solid #ccc;
        background: transparent;
        border-spacing: 0px;
    }
    table.tabela td {
        background: none;
    }

    table.tbitem td {
        border: 1px solid #ccc;
    }

    tr.etapas {
        padding: 0px;
        margin: 0px;
    }

</style>

<!-- ========== INCIO TTULO ========== -->
<div id="titulo">
<div>Custos por Produtos <?php echo montaBotaoVoltar($controller, $links); ?></div></div>
</div>
<!-- ========== FIM TTULO ========== -->

<!-- ========== INCIO CONTEDO ========== -->
<div id="conteudo">

    <?php
    if(count($this->Produtos)>0) {

        foreach ($this->Produtos as $produtos): ?>

            <div class="_produto">

                <table class='tabela' style="background: transparent">
                    <tbody>
                        <tr><td align="left"><input type="button" id="" class="btn_adicionar produto" /><?php echo $produtos->DescricaoProduto;?></td></tr>

                        <?php foreach ($this->Etapa as $etapa) : ?>
                            <?php $CadastrarProduto = $this->url(array('controller' => 'manterorcamento', 'action' => 'cadastrarprodutos'))."?produto=".$produtos->CodigoProduto."&etapa=".$etapa->idEtapa."&etapaNome=".$etapa->DescricaoEtapa."&idPreProjeto=".$produtos->idProposta;?>

                            <?php if ($produtos->CodigoProduto) : ?>

                                <tr class="etapas" style="display: none;">
                                    <td>
                                        <table summary="Produto" style="margin: 0px;">
                                            <tbody>
                                                <tr onclick="abrirDinamico('.itens_<?php echo $produtos->CodigoProduto."_".$etapa->idEtapa; ?>', $(this));" style="cursor:pointer">
                                                    <th width="30px">
                                                        <img style="cursor: pointer; width: 14px; height: 14px;" class="" src="<?php echo $this->baseUrl(); ?>/public/img/navigation-right.png" alt="Adicionar" />
                                                    </th>
                                                    <th class="esquerda"><?php echo $etapa->DescricaoEtapa; ?></th>
                                                    <th class="direita">
                                                        <input type="button" class="btn_novo" onclick="abrirFrmCadastroItem('<?php echo $CadastrarProduto; ?>');" />
                                                    </th>
                                               </tr>
                                                <tr class="itens_<?php echo $produtos->CodigoProduto."_".$etapa->idEtapa; ?>" style='display: none;'>
                                                    <td colspan="3" style="margin: 0; padding:10px;">
                                                        <table class="tbitem" width="100%" style='margin: 0; border: 1px solid #aaa;' >
                                                            <tr class="destacar" align="center">
                                                                <td>&Iacute;tem</td>
                                                                <td>Unidade</td>
                                                                <td>Qtde</td>
                                                                <td>Ocorr&ecirc;ncia</td>
                                                                <td>Valor Unit&aacute;rio</td>
                                                                <td>Total</td>
                                                                <td>Localiza&ccedil;&atilde;o (Munic&iacute;pio/UF)</td>
                                                                <!--<td>Mecanismo</th>-->
                                                                <td colspan="2" width="10%">A&ccedil;&otilde;es</td>
                                                            </tr>
                                                            <?php if(isset($this->Item)) : ?>
                                                                <?php foreach ($this->Item as $itens) : ?>
                                                                    <?php if ($produtos->CodigoProduto == $itens->CodigoProduto) :
                                                                        if ($etapa->idEtapa == $itens->idEtapa) :  ?>
                                                                            <tr class='fundo' style='background-color: #fff' align="center">
                                                                                <td><?php echo $itens->DescricaoItem; ?></td>
                                                                                <td><?php echo $itens->Unidade; ?></td>
                                                                                <td><?php echo number_format($itens->Quantidade,0) ?></td>
                                                                                <td><?php echo number_format($itens->Ocorrencia,0) ?></td>
                                                                                <td><?php echo number_format($itens->ValorUnitario, 2, ",", ".") ?></td>
                                                                                <td><?php echo number_format(($itens->Quantidade * $itens->ValorUnitario) * $itens->Ocorrencia, 2, ",", ".") ?></td>
                                                                                <td><?php echo $itens->Municipio; ?>/<?php echo $itens->SiglaUF; ?></td>
                                                                                <td width="5%">
                                                                                    <input type="button" id="btn_editar" name="editar" style="width: 88px" class="btn_editar" onclick="abrirFrmCadastroItem('<?php echo $this->url(array('controller'=>'manterorcamento', 'action'=>'editarprodutos')); ?>?item=<?php echo $this->escape($itens->idItem); ?>&etapa=<?php echo $this->escape($etapa->idEtapa);?>&produto=<?php echo $this->escape($produtos->CodigoProduto);?>&idPlanilhaProposta=<?php echo $itens->idPlanilhaProposta;?>&idPreProjeto=<?php echo $this->escape($produtos->idProposta);?>');">
                                                                                </td>
                                                                                <td class='centro' width="5%">
                                                                                    <input type="button" id="btn_excluir" name="excluir" style="width: 88px" class="btn_exclusao" onclick="excluir(<?php echo $itens->idPlanilhaProposta; ?>);">
                                                                                </td>
                                                                            </tr>
                                                                        <?php endif; ?>
                                                                    <?php endif; ?>
                                                                <?php endforeach; ?>
                                                            <?php else : ?>
                                                                <tr  class='fundo'>
                                                                    <td colspan="10">
                                                                        <div class="center" align="center">Nenhum item cadastrado</div>
                                                                    </td>
                                                                </tr>
                                                            <?php endif; ?>
                                                        </table>
                                                    </td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </td>
    <!--                            </div>-->
                                </tr><!-- FIM DIV ETAPAS -->
                            <?php endif; ?>
                        <?php endforeach; ?> <!-- FIM FOREACH ETAPAS -->

                        <tr class="etapas" style="display: none;">
                            <td>
                                <?php if ($this->EtapaCusto) : ?>
                                    <div class="custosadministrativos">

                                        <table class='tabela' style="background: transparent">

                                            <?php foreach ($this->EtapaCusto as $etapaCusto) : ?>
                                                <tr class="etapas">
                                                    <td>
                                                        <table summary="Produto" style="margin: 0px;">
                                                            <tr>
                                                                <th class="centro"><?php echo $etapaCusto->DescricaoEtapa; ?> - Produto: <?php echo $produtos->DescricaoProduto; ?></th>
                                                            </tr>
                                                            <tr id="itens_<?php echo $produtos->CodigoProduto."_".$etapaCusto->idEtapa; ?>" width="100%">
                                                                <td colspan="2" style="margin: 0; padding:10px;">

                                                                    <?php if($this->ItensEtapaCusto) : ?>
                                                                        <table class="tbitem" width="100%" style='margin: 0; border: 1px solid #aaa;' >
                                                                            <tr class="destacar" align="center">
                                                                                <td>&Iacute;tem</td>
                                                                                <td>Munic&iacute;pio/UF</td>
                                                                                <td>Total</td>
                                                                            </tr>
                                                                            <?php foreach ($this->ItensEtapaCusto as $itemEtapaCusto) : ?>
                                                                                   <?php if ($etapaCusto->idEtapa == $itemEtapaCusto->idEtapa) :  ?>
                                                                                        <tr class='fundo' style='background-color: #fff' align="center">
                                                                                            <td><?php echo $itemEtapaCusto->DescricaoItem; ?></td>
                                                                                            <td><?php echo $itemEtapaCusto->Municipio; ?>/<?php echo $itemEtapaCusto->SiglaUF; ?></td>
                                                                                            <td><?php echo number_format($itemEtapaCusto->valorunitario, 2, ",", ".") ?></td>
                                                                                        </tr>
                                                                                    <?php endif; ?>

                                                                            <?php endforeach; ?>
                                                                        </table>
                                                                    <?php else: ?>
                                                                        <div class="center" align="center">Nenhum item cadastrado</div>
                                                                    <?php endif; ?>
                                                                </td>
                                                            </tr>
                                                        </table>
                                                    </td>
                                                </tr>
                                            <?php endforeach; ?> <!-- FIM FOREACH ETAPAS -->
                                        </table>
                                    </div>
                                <?php endif; ?>
                            </td>
                        </tr>
                </table>
            </div>


        <?php endforeach; ?>

        <?php } else { ?> <!-- FIM FOREACH PRODUTOS -->
        <br>
        <div class="center" align="center">Nenhum produto cadastrado</div>
        <br>
    <?php } ?>
    <br>
</div>
<!-- FIM DIV CONTEUDO -->
<div id="msg"></div>
<script>
function excluir(idPlanilhaProposta)
{
	$("#msg").html('Tem certeza que deseja excluir o registro?');
	$("#msg").dialog('open');
	$("#msg").dialog
    ({
    	width:350,
        height: 180,
        modal: true,
        draggable: false,
        resizable: false,
        closeOnEscape: false,
        buttons: {
            'Não': function()
            {
                $(this).dialog('close');
            },
            'Sim': function()
            {
            	window.location.href="<?php echo $this->url(array('controller'=>'manterorcamento', 'action'=>'excluiritensprodutos')); ?>?idPlanilhaProposta="+idPlanilhaProposta+"&retorno=produtoscadastrados&idPreProjeto=<?php echo $this->idPreProjeto;?>";
            }
        }
    });
	$(".ui-dialog-titlebar-close").remove();
}

</script>
<!-- ========== INCIO RODAP DO CONTEDO ========== -->
<div id="rodapeConteudo"><span></span></div>
<!-- ========== FIM RODAP DO CONTEDO ========== -->
<br clear="all" />