<script type="text/javascript">
    $('#vlunitario').priceFormat({limit: 8});
    $(document).ready(function() {


        <?php if(isset($this->movimentacaoAtual) && $this->movimentacaoAtual != '95'): ?>
            //DESABILITA ALTERACOES NOS DADOS DO FORMULARIO (INCLUIR/ALTERAR/EXCLUIR)
            JSBloquearAlteracaoFormulario();
        <?php endif; ?>

        somaValores();

        $('.soma').keyup(function () {
            var soma = 0;
            var vlunitario = $("#vlunitario").val();

            // retira os pontos e as virgulas, deixando somente numeros
            vlunitario = vlunitario.replace(/\D/g, "");
            vlunitario = vlunitario.replace(/(\d{0})(\d)/, "$1$2");

            // adiciona o ponto na casa decimal
            vlunitario = vlunitario.replace(/(\d)(\d{2})$/, "$1.$2");

            // converte para float e adiciona precisao decimal
            qtd = parseFloat($("#qtd").val()).toFixed(2);
            ocorrencia = parseFloat($("#ocorrencia").val()).toFixed(2);
            valor = parseFloat(vlunitario).toFixed(2);
            soma = parseFloat(qtd * ocorrencia * valor).toFixed(2); // armazena o resultado
            if (soma >= 0) {
                $("#total").val(soma);
            } else {
                $("#total").val(0);
            }
            $("#total").priceFormat();
        });

//
//        if ( $('#item').val() != '') {
//            somaValores();
//        }

        $('.numero').keydown(function (event) {
            if ((event.keyCode >= 96 && event.keyCode <= 105) || (event.keyCode >= 48 && event.keyCode <= 57) || event.keyCode == 8 || event.keyCode == 9) {
                return true;
            }
            else
                return false;
        });

        $("#error").dialog({
            resizable: true,
            width: 450,
            height: 150,
            modal: true,
            autoOpen: false,
            buttons: {
                'OK': function () {
                    $(this).dialog('close');
                }
            }
        });
    });

    function somaValores(){
        var soma = 0;
        var vlunitario = $("#vlunitario").val().replace('R$','');
        var vlunitario = $.trim(vlunitario.replace(',','.'));
        soma = $("#qtd").val()*$("#ocorrencia").val() * vlunitario;
        soma = soma.toFixed(2).replace('.',',');
        $("#total").val(soma);
    }

    function Limpar(valor, validos) {
        // retira caracteres invalidos da string
        var result = "";
        var aux;
        for (var i=0; i < valor.length; i++) {
            aux = validos.indexOf(valor.substring(i, i+1));
            if (aux>=0) {
                result += aux;
            }
        }
        return result;
    }

    //Formata numero tipo moeda usando o evento onKeyDown

    function Formata(campo,tammax,teclapres,decimal) {
        var tecla = teclapres.keyCode;
        vr = Limpar(campo.value,"0123456789");
        tam = vr.length;
        dec=decimal

        if (tam < tammax && tecla != 8){ tam = vr.length + 1 ; }

        if (tecla == 8 )
        { tam = tam - 1 ; }

        if ( tecla == 8 || tecla >= 48 && tecla <= 57 || tecla >= 96 && tecla <= 105 )
        {

            if ( tam <= dec )
            { campo.value = vr ; }

            if ( (tam > dec) && (tam <= 5) ){
                campo.value = vr.substr( 0, tam - 2 ) + "," + vr.substr( tam - dec, tam ) ; }
            if ( (tam >= 6) && (tam <= 8) ){
                campo.value = vr.substr( 0, tam - 5 ) + "." + vr.substr( tam - 5, 3 ) + "," + vr.substr( tam - dec, tam ) ;
            }
            if ( (tam >= 9) && (tam <= 11) ){
                campo.value = vr.substr( 0, tam - 8 ) + "." + vr.substr( tam - 8, 3 ) + "." + vr.substr( tam - 5, 3 ) + "," + vr.substr( tam - dec, tam ) ; }
            if ( (tam >= 12) && (tam <= 14) ){
                campo.value = vr.substr( 0, tam - 11 ) + "." + vr.substr( tam - 11, 3 ) + "." + vr.substr( tam - 8, 3 ) + "." + vr.substr( tam - 5, 3 ) + "," + vr.substr( tam - dec, tam ) ; }
            if ( (tam >= 15) && (tam <= 17) ){
                campo.value = vr.substr( 0, tam - 14 ) + "." + vr.substr( tam - 14, 3 ) + "." + vr.substr( tam - 11, 3 ) + "." + vr.substr( tam - 8, 3 ) + "." + vr.substr( tam - 5, 3 ) + "," + vr.substr( tam - 2, tam ) ;}
        }

    }
</script>

<div class="container">
    <div class="row">
        <div class="col s12">

            <h6 class="light" >Cadastrar novo item <span class="badge" data-badge-caption="Etapa: <?php echo $this->Etapa['Descricao']; ?> - Local de realizacao: <?php echo $this->Municipio['Descricao']; ?> - <?php echo $this->Estado['Descricao']; ?>"></span></h6>

            <?php foreach ($this->Dados as $dados) : ?>
                <form name="form" id="form" method="post" action ="<?php echo $this->url(array('module'=>'proposta', 'controller' => 'manterorcamento', 'action' => 'salvaritem')); ?>">
                    <input type="hidden" name="produto" id="produto" value="<?php echo $dados->CodigoProduto ?>" />
                    <input type="hidden" name="idPlanilhaProposta" id="idPlanilhaProposta" value="<?php echo $dados->idPlanilhaProposta ?>" />
                    <input type="hidden" name="idPreProjeto" id="idPreProjeto" value="<?php echo $this->idPreProjeto ?>" />
                    <input type="hidden" name="uf" id="uf" value="<?php echo $this->Estado['idUF']; ?>" />
                    <input type="hidden" name="municipio" id="municipio" value="<?php echo $this->Municipio['idMunicipioIBGE'] ?>" />
                    <input type="hidden" name="idPlanilhaEtapa" id="idPlanilhaEtapa" value="<?php echo $this->Etapa['idPlanilhaEtapa'] ?>" />

                    <div class="row">
                        <div class="col s12">
                            <table style="margin-top: 0px;">
                                <thead>
                                <tr>
                                    <th><label for="item">Item</label></th>
                                    <th><label for="unidade">Unidade</label></th>
                                    <th><label for="qtdDias">Qtd de dias</label></th>
                                    <th><label for="qtd">Quantidade</label></th>
                                    <th><label for="ocorrencia">Ocorr&ecirc;ncia</label></th>
                                    <th><label for="vlunitario">Valor Unit&aacute;rio (R$)</th>
                                    <th><label for="total">Total (R$)</th>
                                </tr>
                                </thead>
                                <tbody>
                                <tr>
                                    <td>
                                        <select class="select_simples valida" id="item" name="item" style="width: 80%">
                                            <option> - Selecione um item - </option>
                                            <?php foreach($this->Item as $itens) : ?>
                                                <option value="<?php echo $itens->idPlanilhaItens ?>" <?php echo $dados->idItem == $itens->idPlanilhaItens ? "selected" : ""; ?>><?php echo $itens->Descricao ?></option>
                                            <?php endforeach; ?>
                                        </select>
                                    </td>
                                    <td>
                                        <select class="select_simples valida" id="unidade" name="unidade">
                                            <option value="<?php echo "" ?>"> - Selecione - </option>
                                            <?php foreach($this->Unidade as $unidade) {?>
                                                <option value="<?php echo $unidade->idUnidade ?>" <?php echo ($dados->Unidade == $unidade->idUnidade) ? "selected" : ""; ?>><?php echo $unidade->Descricao ?></option>
                                            <?php } ?>
                                        </select>
                                    </td>
                                    <td>
                                        <input type="text" maxlength="4" class="input_simples valida numero" size="4" value="<?php echo isset($dados->QtdDias) ? $dados->QtdDias: ''; ?>" name='qtdDias' id='qtdDias' />
                                    </td>
                                    <td>
                                        <input type="text" class="input_simples valida soma numero" size="3" id="qtd" maxlength="10" name="qtd" value="<?php echo isset($dados->Quantidade) ? (int) $dados->Quantidade : ''; ?>">
                                    </td>
                                    <td>
                                        <input type="text" maxlength="4" class="input_simples valida soma numero" size="3" id="ocorrencia" maxlength="10" name="ocorrencia" value="<?php echo isset($dados->Ocorrencia) ? (int) $dados->Ocorrencia : ''; ?>">
                                    </td>
                                    <td>
                                        <input type="text" maxlength="13" class="input_simples valida soma numero" size="10" id="vlunitario" name="vlunitario" value="<?php echo isset($dados->ValorUnitario) ? number_format($dados->ValorUnitario, 2, ",", ".") : '';?>">
                                    </td>
                                    <td>
                                        <input type="text" value="" maxlength="6" class="input_simples valida" size="15" name="total" id="total" readonly="readonly">
                                    </td>
                                </tr>
                                </tbody>
                            </table>
                            <table style="margin: 0px;">
                                <tr>
                                    <td align="left"><label for="uf">Fonte de recurso:</label> <br />
                                        <select class="select_simples valida" id="fonterecurso" name="fonterecurso">
                                            <?php foreach($this->Recurso as $recurso) {?>
                                                <option <?php echo ($recurso->idverificacao == 109) ? 'selected' : ''; ?>  value="<?php echo $recurso->idverificacao ?>"><?php echo $recurso->verificacaodescricao ?></option>
                                            <?php } ?>
                                        </select>
                                    </td>
                                </tr>
                                <tr>
                                    <td align="justify">
                                        <label for="edito1">Detalhamento / Justificativa / Observa&ccedil;&otilde;es</label>
                                        <textarea cols="80" id="editor1" name="editor1" rows="7" class="textarea_simples"><?php echo $dados->Justificativa; ?></textarea>
                                    </td>
                                </tr>
                            </table>
                        </div>
                    </div>

                    <table class="tabela" cellpadding="0" cellspacing="0">
                        <tr>
                            <td class="center-align">
                                <button class="btn-salvar btn waves-effect waves-light" type="submit" name="action">Salvar
                                    <i class="material-icons right">send</i>
                                </button>
<!--                                <input type="button" class="btn_salvar" />-->
                            </td>
                        </tr>
                    </table>

                </form>
            <?php endforeach;?>
        </div>
    </div>
</div>